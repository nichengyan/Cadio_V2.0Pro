#define 	MAIN_Fosc		40000000L	//定义主时钟
#include    "TYPE.h"
#include    "oled.h"
#include    "Key.h"
#include    <stdlib.h>
#include    <stdio.h>
#include    <math.h>
#include    "Gui.h"
#define pi 3.1415926
/*--------------------------------------------------------------------------
Cadio Laser
Demo For Laser Module 
CopyRight (c) 2024~2024 NCY
All rights reserved.
--------------------------------------------------------------------------*/

uint8_t LaserWarning[]={
/*--  调入了一幅图像：C:\Users\nist\Desktop\LaserWarning_4848.bmp  --*/
/*--  宽度x高度=48x48  --*/
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x0F,0x0F,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0x3F,0x1F,0x03,0xC1,0xC0,0xF0,0xFE,0xFE,0xF0,0xC0,0xC1,0x03,0x1F,0x3F,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x1F,0x07,0x83,
0x80,0xF0,0xFC,0x3E,0x7F,0xFF,0xFF,0x3F,0x3F,0xFF,0xFF,0x7F,0x3E,0xFC,0xF0,0x80,
0x83,0x07,0x1F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x3F,0x0F,0x03,0xC1,0xE0,0xF0,0xFE,0xBF,
0x99,0x9B,0x83,0x03,0x00,0x01,0x01,0x00,0x00,0x01,0x04,0x0A,0x03,0x9B,0x99,0x9D,
0x9F,0x9E,0x98,0x80,0x81,0x03,0x0F,0x3F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0x7F,0x1F,0x07,0x83,0xC0,0xF8,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFB,0xF9,0xFD,0xC8,0xE0,0xF8,0xF8,0x80,0xF8,0xF8,0xF0,0xC0,0xDC,0xFD,0xF9,0xFB,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0xF8,0xC0,0x83,0x07,0x1F,0x7F,0xFF,0xFF,0xFF,
0xFF,0xFB,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,
0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xFB,0xFF

};

uint8_t light_on[]={
/*--  调入了一幅图像：C:\Users\nist\Desktop\素材\light_on.bmp  --*/
/*--  宽度x高度=48x48  --*/
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE7,0xCF,
0x9F,0xBF,0xFF,0x7C,0x30,0xA7,0xBF,0x9F,0x9F,0xBF,0xA1,0x38,0x7F,0x7F,0xFF,0xBF,
0x9F,0xCF,0xF7,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x7D,0x79,0x7B,0x7B,0xFF,
0x07,0xF1,0xFC,0xFE,0xFF,0x8F,0x0F,0x1F,0x7F,0x0F,0x0F,0x9F,0xFF,0xFE,0xFC,0x01,
0x0F,0x7B,0x7B,0x79,0x7D,0x7D,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xDF,0xCF,0xEF,0xF7,
0xFE,0xF8,0xF3,0x87,0x1F,0x7F,0x7F,0x00,0x07,0x00,0x7F,0x7F,0x0F,0xE7,0xF3,0xFC,
0xE7,0xEF,0xEF,0xCF,0xFE,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xE0,0xC0,0x00,0x00,0x00,0x00,0x80,0xC0,0xE0,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};
sbit Wifi=P2^0;
sbit Audio=P2^1;
sbit laser=P1^3;
sbit light=P1^7;
uint16_t  VPWM_Cnt=0;
float VPWM_Freq=0,VPWM_Duty=0;
int F=1000,dF=1;
float D=0.5,dD=0.1;
uint8_t option=0;
uint8_t keynum;
uint8_t Status=0;//1:On 0:Off
uint8_t led=0;
Page pMain;


void Pause();//防止误按
void delayms(uint16_t t);//毫秒级延迟函数
void MoveTo(float *from,float to,float step);
void VPWM_Init();
void VPWM_Set(uint16_t Freq,float Duty);
void main(void)
{   
    P0M0=0x00;
    P0M1=0x00;
    P1M0=0x00;   //设置为高阻抗
    P1M1=0x03; 
    P2M0=0x00;
    P2M1=0x00;
    P3M0=0x00;
    P3M1=0x00;
    P5M0=0x00;
    P5M1=0x00; 
    light=0;
    Wifi=0;
    Audio=0;
    laser=0;
    VPWM_Init();
    OLED_Init();
    OLED_Display_On();
    OLED_ColorTurn(0);
    OLED_Clear();    
    Gui_Init();
    Gui_CreatePage(&pMain,128,64);
    Gui_ClearBufferBit(&pMain,0);
    EA=1;
    ET0=1;
    Gui_DrawBmp(&pMain,40,0,48,48,LaserWarning);
    Gui_Printf(&pMain,43,50,1,0,"Caution!");
    Gui_Flush(&pMain);
    Gui_ClearBufferBit(&pMain,0);
    delayms(1000);
    while(1){
        Gui_DrawBmp(&pMain,40,0,48,48,LaserWarning);
        Gui_Printf(&pMain,43,50,1,0,"Caution!");
        Gui_Printf(&pMain,1,10,1,0,"Freq:");
        Gui_Printf(&pMain,1,18,1,0,"%dHz",F);
        Gui_Printf(&pMain,1,30,1,0,"FStep:");
        Gui_Printf(&pMain,1,38,1,0,"%d",dF);
        
        Gui_Printf(&pMain,89,10,1,0,"Duty:");
        Gui_Printf(&pMain,89,18,1,0,"%.2f",D);
        Gui_Printf(&pMain,89,30,1,0,"DStep:");
        Gui_Printf(&pMain,89,38,1,0,"%.2f",dD);
        Gui_Printf(&pMain,0,48,1,1,"Laser");
        if(Status) Gui_Printf(&pMain,88,48,1,1,"  On");
        else Gui_Printf(&pMain,88,48,1,1," Off");
        keynum=Key_Scan()%0x00ff; 
        if(keynum==0x3d) {Status=!Status;Pause();}
        if(keynum==0x4a)  {if(option<3) {option+=1;} else{option=0;}}
        if(keynum==0x48)  {if(option>0) {option-=1;} else{option=3;}}  
        if(keynum==0x41)  {
            led=!led;
            Gui_ClearBufferBit(&pMain,0);
            if(!led){
                Gui_DrawBmp(&pMain,40,0,48,48,light_on);
            }else{
                Gui_DrawBmpColorRev(&pMain,40,0,48,48,light_on);
            }
            if(led) {light=1;Wifi = 1;}
            if(!led) {light=0; Wifi = 0; }
            Gui_Flush(&pMain);
            delayms(5000);
            
        }
        if(option==0){
            Gui_DrawRectangleWired(&pMain,0,9,40,18,1);
            if(keynum==0x44)  {if(F<1000) {F+=dF;} else{F=1;}}
            if(keynum==0x49)  {if(F>1) {F-=dF;} else{F=1000;}}   
        }
        if(option==1){
            Gui_DrawRectangleWired(&pMain,0,27,40,18,1);
            if(keynum==0x44)  {if(dF<10) {dF+=1;} else{dF=1;}}
            if(keynum==0x49)  {if(dF>1) {dF-=1;} else{dF=10;}}            
        }
        if(option==2){
            Gui_DrawRectangleWired(&pMain,88,9,40,18,1);
            if(keynum==0x44)  {if(D<1) {D+=dD;} else{D=0;}}
            if(keynum==0x49)  {if(D>0) {D-=dD;} else{D=1;}}             
        }
        if(option==3){
            Gui_DrawRectangleWired(&pMain,88,27,40,18,1);
            if(keynum==0x44)  {if(dD<0.1) {dD+=0.01;} else{dD=0.01;}}
            if(keynum==0x49)  {if(dD>0.01) {dD-=0.01;} else{dD=0.1;}}               
        }
        Gui_Flush(&pMain);  
        Gui_ClearBufferBit(&pMain,0);
        VPWM_Set(F,D);
    }
}
void Pause(){while(Key_Scan()!=0xffff);}
void delayms(uint16_t t){
    uint16_t i;
    while(t--) for(i=0;i<600;i++);
}
void MoveTo(float *from,float to,float step){
    (*from)+=(to-(*from))*step;
}
void VPWM_Init()	
{    	                    ////100微秒@40MHz
	AUXR |= 0x80;			//定时器时钟1T模式
	TMOD &= 0xF0;			//设置定时器模式
	TL0 = 0x60;				//设置定时初始值
	TH0 = 0xF0;				//设置定时初始值
	TF0 = 0;				//清除TF0标志
	TR0 = 1;				//定时器0开始计时
}

void VPWM_Set(uint16_t Freq,float Duty){
    VPWM_Freq=1.0/(float)Freq;
    VPWM_Duty=pow(2,Duty)-1;
}    
void VPWM_Work() interrupt 1{
    if(Status==0) {laser=0;return;}
    if(VPWM_Cnt>10000*VPWM_Freq) VPWM_Cnt=1;
    VPWM_Cnt++;
    if(VPWM_Cnt>VPWM_Duty*VPWM_Freq*10000) laser=0;
    else laser=1;
}