#include "stc.h"
#include "usb.h"
#include "scsi.h"
#include "memory.h"
#include "oled.h"
#include "ADC.h"
#include "SD.h"
void sys_init();
uchar Key_Scan();
void delay(uint t)
{
    uchar i;
    while (t--)
        for (i = 0; i < 125; i++)
            ;
}
code unsigned char Icon[] = {
    /*--  调入了一幅图像：C:\Users\nist\Desktop\素材\usb.bmp  --*/
    /*--  宽度x高度=64x48  --*/
    0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x3F, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xF0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x1F, 0x0F, 0x0F, 0x1F, 0x3F, 0x7F, 0x7F,
    0x7F, 0x7F, 0x3F, 0x4F, 0x67, 0x73, 0x78, 0x7C, 0x7C, 0x7C, 0x78, 0x70, 0x70, 0x7C, 0x7F, 0x7F,
    0x7F, 0x7F, 0x7F, 0x7F, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xE3, 0xE3, 0xE3, 0xF3, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xF0, 0xF0, 0xF0, 0xF0, 0xF8, 0xFE, 0xFE,
    0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFC, 0xF0, 0xE6, 0xCE, 0x3E, 0x3E, 0x3E, 0x3E, 0x1E, 0x1E,
    0x1E, 0x1E, 0xFE, 0xFE, 0xF8, 0xFC, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0x0F, 0xCF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFE, 0xFC, 0xFC,
    0xFC, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x0F,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
sbit Wifi = P2 ^ 0;
sbit Audio = P2 ^ 1;
sbit laser = P1 ^ 3;
sbit light = P1 ^ 7;
sbit flash_cs1 = P3 ^ 5;
sbit flash_cs2 = P2 ^ 3;
sbit sd_cs = P1 ^ 6;
uchar keynum = 0, disk = 0;
uint8_t buf[2048 + 10];
uint8_t in[1024];
void main()
{
    sys_init();
    delay(1000);
    
        OLED_Printf(0, 0, 16, "Select Disk:");
        while (1)
        {
            keynum = Key_Scan();
            if (!disk)
            {
                OLED_Printf(0, 2, 16, ">");
                OLED_Printf(0, 4, 16, " ");
            }
            if (disk)
            {
                OLED_Printf(0, 2, 16, " ");
                OLED_Printf(0, 4, 16, ">");
            }
            OLED_Printf(8, 2, 16, "Disk0: Cadio8M");
            OLED_Printf(8, 4, 16, "Disk1: User_4M");
            if (keynum == 1 || keynum == 2)
                disk = !disk;
            if (keynum == 3)
                break;
            delay(5000);
        }
        OLED_Clear();
    
    memory_init(disk);
/*
    //SD_ReadDisk(buf,0,4);
    in[510] = 0x77;
    in[511] = 0x88;
    SD_WriteDisk(in,0,1);
    delay(1000);
    SD_ReadDisk(buf,0,1);
    OLED_Printf(0 , 0 ,16, "0x%02bx  0x%02bx",buf[510],buf[511]);
    while(1);
*/
    usb_init();
     EA = 1;
     OLED_ShowString(0, 0, "USB_MSC...", 16);
     OLED_DrawBMP(32, 2, 64, 48, Icon);

    while (1)
    {
        
        OLED_ShowChar(96, 0, '|', 16);
        delay(5000);
        OLED_ShowChar(96, 0, '/', 16);
        delay(5000);
        OLED_ShowChar(96, 0, '-', 16);
        delay(5000);
        OLED_ShowChar(96, 0, '\\', 16);
        delay(5000);
        
        //usb_isr();
        //light = ~light;
    }
}
void sys_init()
{
    P_SW2 |= 0x80; // 扩展寄存器(XFR)访问使能
    P0M0 = 0x00;
    P0M1 = 0x00;
    P1M1 = 0x3f;
    P1M0 = 0x00; // 锟斤拷锟斤拷为锟斤拷锟借抗
    P2M0 = 0x00;
    P2M1 = 0x00;
    P3M0 = 0x00;
    P3M1 = 0x00;
    P5M0 = 0xff;
    P5M1 = 0x00;

    Wifi = 0;
    laser = 0;
    Audio = 0;
    light = 0;
    flash_cs1 = 1;
    flash_cs2 = 1;

    OLED_Init();         // 初始化OLED
    OLED_ColorTurn(0);   // 0正常显示，1 反色显示
    OLED_DisplayTurn(0); // 0正常显示 1 屏幕翻转显示
    OLED_Clear();
}
uchar Key_Scan()
{
    uchar i, j;
    uint tmp, samples[11];
    ADC_Init();
    for (i = 0; i < 10; i++)
    {
        samples[i] = ADC_Result(ADC_CH0, ADC_SPEEDLL);
        for (j = i - 1; j > 0 && i > 0; j--)
        {
            if (samples[j + 1] < samples[j])
            {
                tmp = samples[j + 1];
                samples[j + 1] = samples[j];
                samples[j] = tmp;
            }
        }
    }
    if (samples[5] >= 0 && samples[5] <= 209)
        return 1; // 向下
    else if (samples[5] >= 381 && samples[5] <= 533)
        return 2; // 向上
    else if (samples[5] >= 680 && samples[5] <= 819)
        return 3; // 确认
    else
        return 0xff;
}
