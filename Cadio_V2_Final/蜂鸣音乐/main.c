#include <_STC8H_.H>
#include <stdlib.h>
#include "oled.h"
#include "中科大校歌.h"
//#include "jingle_bell.h"
#include <math.h>
sbit en = P2^1;
sbit speaker=P5^4;
sbit led=P6^3;  
sbit Wifi=P2^0;
sbit Audio=P2^1;
sbit laser=P1^3;
sbit light=P1^7;
#define F0 40000000L
unsigned  music=0;
unsigned char stop=0;
//1,1#,2,2#,3,4,4#,5,5#,6,6#,7; 
code unsigned int tab[4][15]={ 
    {262,277,294,311,330,349,370,392,415,440,466,494},
	{523,554,587,622,659,698,740,784,831,880,932,988},
	{1046,1109,1175,1245,1318,1397,1480,1568,1661,1760,1865,1976},
	{2093,2218,2349,2489,2637,2794,2960,3136,3323,3520,3729,3951} 
};
code unsigned char bmp[] = {

/*--  调入了一幅图像：C:\Users\nichengyan\Desktop\下载.bmp  --*/
/*--  宽度x高度=64x64  --*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x80,0x80,0xC0,0xC0,0xC0,0xE0,0xE0,0x60,0xE0,0x60,0x60,0xF0,0xF0,0xF0,
0xF0,0xF0,0xF0,0xE0,0x60,0x60,0x60,0xE0,0xE0,0xC0,0xC0,0xC0,0x80,0x80,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xE0,0xB0,0xB8,0x7C,0x7C,0xFE,0xFE,
0xDF,0x87,0x83,0xC1,0xC3,0xC7,0xFF,0xFF,0x7F,0x3B,0x3C,0x30,0x10,0x1F,0x1F,0x1F,
0x1F,0x1F,0x1B,0x11,0x34,0x30,0x66,0x7F,0xFF,0xFF,0xDF,0xDF,0x8F,0x8F,0xE7,0xF7,
0xFE,0xFE,0xFC,0xF8,0xF8,0xF0,0xE0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x80,0xE0,0xF8,0x3C,0x1F,0x3F,0x3F,0xFC,0xF8,0xF0,0xF0,0x72,0x38,0x1F,
0x8F,0xCF,0xE7,0xE7,0xF3,0xE9,0xF8,0xF4,0xFC,0xFA,0xFE,0xFE,0xFE,0xFF,0xE7,0xE7,
0xCF,0xEF,0xFE,0xFE,0xBE,0x7E,0x7A,0xFC,0xF4,0xF9,0xE9,0xD7,0xA7,0x47,0x8F,0x0F,
0x1F,0x3F,0x7D,0xF0,0xFC,0xFC,0x7F,0xBF,0x3F,0x7F,0x1C,0x78,0xE0,0x00,0x00,0x00,
0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0xFC,0xFC,0xFE,0xFE,0x0F,0x01,0x00,0xC0,0x38,0xF6,
0xFD,0xFE,0xFF,0xFF,0x9F,0xFF,0xDF,0x1F,0xBF,0xDF,0x5F,0xBF,0x9F,0x1F,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0x7F,0xFE,0x70,0xFA,0xFD,0xFB,0xF7,0x3F,0xFF,0xFF,0xFE,0xFB,
0xEC,0xF0,0x00,0x00,0x03,0x0E,0xFE,0xFC,0xFE,0xFE,0xFF,0xFF,0xFF,0xFF,0xF8,0x00,
0x00,0x3F,0xFF,0xFF,0xFF,0xCD,0x7D,0xFF,0xFF,0xFF,0xFC,0xF0,0xC0,0x0F,0x63,0xBF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x7F,0x7F,0x7F,0x3F,0x3F,0x3F,0x7F,0xFF,
0xF7,0x7B,0x3D,0x3E,0x7F,0x7F,0x7E,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,
0xDF,0x3F,0x00,0xE0,0xF0,0xFE,0xFF,0xFF,0x3F,0xBF,0xE1,0xFF,0xFF,0xFF,0x1F,0x00,
0x00,0x00,0x03,0x0F,0x3F,0x7F,0xFF,0xF9,0xEF,0xDF,0xDF,0x7F,0xFF,0xFC,0xF0,0xC1,
0x86,0x0B,0x17,0x2E,0x3E,0x5E,0xBE,0xFE,0x7E,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xF8,
0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0x7E,0xFE,0xBE,0x7E,0x5E,0x2E,0x16,0x0B,0x05,0x83,
0xC1,0xF0,0xFE,0xFF,0xFF,0x7F,0xDB,0xF7,0xFD,0xFF,0x7F,0x1F,0x07,0x01,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x0F,0x1F,0x1F,0x3D,0x7F,0x7B,0xFF,
0xEF,0xE7,0xFE,0xFC,0xBC,0xB8,0xF8,0x78,0x79,0xF9,0xF9,0xF9,0xFB,0xFB,0xFB,0xFB,
0xFB,0xFB,0x7B,0xF9,0xF9,0x39,0xF9,0x78,0xF8,0xF8,0xDC,0x9C,0xDE,0xCE,0xEF,0xFF,
0xF3,0x7B,0x7D,0x3E,0x1D,0x0F,0x0F,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0x01,0x03,0x03,0x03,0x07,0x07,0x07,0x07,0x0F,0x0F,0x0E,0x0F,0x0F,0x0E,0x0E,
0x0E,0x0E,0x0E,0x0F,0x0F,0x0E,0x0F,0x07,0x07,0x07,0x07,0x03,0x03,0x01,0x01,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00

};
unsigned int notes_to_id(int note,int up){
	if(up==0){
		switch(note){
			case 1: return 0;
			case 2: return 2;
			case 3: return 4;
			case 4: return 5;
			case 5: return 7;
			case 6: return 9;
			case 7: return 11;
		}
	}else if(up==1){
		switch(note){
			case 1: return 1;
			case 2: return 4;
			case 4: return 6;
			case 5: return 8;
			case 6: return 10;
		}
	}
}
void reset(){
	EA=1;
	ET0=1;
	TMOD=0X01;
	TH0=0XFF;
	TL0=0XFF;
    P1M0=0x00;
    P1M1=0x00;
    P2M0=0x03; 
    P2M1=0x00;
    P3M0=0x00;
    P3M1=0x00;
    P5M0=0x00


;
    P5M1=0x00;
    Wifi=0;
    laser=0;
    Audio=0;
    light=0;
	speaker=0;
    stop=0;
    en = 1;
}
void delay(unsigned int t){
    unsigned int i;
    while(t--) for(i=0;i<400;i++);
}
void outit() interrupt 1 {
	if(stop!=0) return; 
    speaker=~speaker;
	TH0=music/256;
	TL0=music%256;
	TR0=1;
}
void main(){    
    unsigned int i,lenth;
    reset();    
    OLED_Init();
    OLED_Display_On();
    OLED_ColorTurn(0);
    OLED_Clear();
    OLED_DrawBMP(32,0,64,64,bmp);
    delay(10000);
	lenth=sizeof(notes)/1;
    TR0=1;
    for(i=0;i<lenth;i++){
         if(notes[i]!=-1&&notes[i]!=0){
            stop=0;   
            music=0xffff-(F0/tab[levels[i]][notes_to_id(notes[i],0)]/12);
            delay(4*rythm*fabs(times[i]));
         }else if(notes[i]==0){
            stop=1;
			speaker=0;
            delay(4*rythm*fabs(times[i]));
         }else{
		      stop=1;
			  delay(6);
		}     
		stop=1;
		delay(2);
    }
	 stop=1;
	 return;
}